version: '3.8'

services:
  # --- APP SERVICE ---
  app:
    # Use Build from Source logic to leverage our fixes
    build:
      context: .
      dockerfile: Dockerfile.build
    environment:
      # Core Config
      - APP_NAME=${APP_NAME:-Alga PSA}
      - APP_ENV=${APP_ENV:-production}
      - NODE_ENV=${APP_ENV:-production}
      - DB_TYPE=${DB_TYPE:-postgres}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - HOST=${HOST:-0.0.0.0}
      
      # Authentication
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_SESSION_EXPIRES=${NEXTAUTH_SESSION_EXPIRES:-3600}
      - ALGA_AUTH_KEY=${ALGA_AUTH_KEY}
      - CRYPTO_KEY=${CRYPTO_KEY}
      
      # Database - Application Connection
      # Now using standard app_user thanks to our code fix
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_NAME_SERVER=${DB_NAME_SERVER:-server}
      - DB_USER_SERVER=${DB_USER_SERVER:-app_user}
      - DB_PASSWORD_SERVER=${DB_PASSWORD_SERVER}
      
      # Database - Admin Connection (for migrations/setup if needed by app)
      - DB_USER_ADMIN=${DB_USER_ADMIN:-postgres}
      - DB_PASSWORD_ADMIN=${POSTGRES_PASSWORD}
      
      # Redis & Hocuspocus
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - DB_NAME_HOCUSPOCUS=${DB_NAME_HOCUSPOCUS:-hocuspocus}
      - DB_USER_HOCUSPOCUS=${DB_USER_HOCUSPOCUS:-app_user}
      - DB_PASSWORD_HOCUSPOCUS=${DB_PASSWORD_SERVER}
      
      # Enterprise / SSO Configuration
      - NEXT_PUBLIC_EDITION=${NEXT_PUBLIC_EDITION:-enterprise}
      # SSO Secrets (ensure these are set in Coolify environment variables)
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - GOOGLE_OAUTH_CLIENT_SECRET=${GOOGLE_OAUTH_CLIENT_SECRET}
      - MICROSOFT_OAUTH_CLIENT_ID=${MICROSOFT_OAUTH_CLIENT_ID}
      - MICROSOFT_OAUTH_CLIENT_SECRET=${MICROSOFT_OAUTH_CLIENT_SECRET}
      - MICROSOFT_OAUTH_TENANT_ID=${MICROSOFT_OAUTH_TENANT_ID}
      
      # Email
      - EMAIL_ENABLE=${EMAIL_ENABLE:-false}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@p2pit.com.au}
      - EMAIL_HOST=${EMAIL_HOST:-localhost}
      - EMAIL_PORT=${EMAIL_PORT:-587}
      - EMAIL_USERNAME=${EMAIL_USERNAME:-dummy}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-dummy}
      
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
        
    healthcheck:
      test:
        - CMD-SHELL
        - 'wget --no-verbose --tries=1 --spider http://localhost:3000/api/auth/session || exit 1'
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 90s
    ports:
      - '${EXPOSE_SERVER_PORT:-3000}:3000'


  # --- POSTGRES DATABASE ---
  postgres:
    image: 'postgres:15-alpine'
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${DB_NAME_SERVER:-server}
    volumes:
      - 'postgres-data-fresh-v2:/var/lib/postgresql/data'
    healthcheck:
      test:
        - CMD-SHELL
        - 'pg_isready -U ${POSTGRES_USER:-postgres} -d ${DB_NAME_SERVER:-server}'
      interval: 10s
      timeout: 5s
      retries: 5

  # --- INIT-DB SIDECAR ---
  # Ensures app_user and databases exist before migrator runs
  # --- INIT-DB SIDECAR ---
  # Ensures app_user and databases exist before migrator runs
  init-db:
    build:
      context: .
      dockerfile: Dockerfile.build
    restart: "no"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Connection details for setup script
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_USER_ADMIN=${DB_USER_ADMIN:-postgres}
      - DB_PASSWORD_ADMIN=${POSTGRES_PASSWORD}
      - DB_NAME_SERVER=${DB_NAME_SERVER:-server}
      - DB_USER_SERVER=${DB_USER_SERVER:-app_user}
      - DB_PASSWORD_SERVER=${DB_PASSWORD_SERVER}
      # Required for check_seeds_status
      - NODE_ENV=production
    command: ["/app/setup/entrypoint.sh"]

  # --- REDIS ---
  redis:
    image: 'redis:7-alpine'
    command: 'redis-server --requirepass ${REDIS_PASSWORD}'
    volumes:
      - 'redis-data:/data'
    healthcheck:
      test:
        - CMD
        - redis-cli
        - '-a'
        - '${REDIS_PASSWORD}'
        - ping
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data-fresh-v2: null
  redis-data: null
